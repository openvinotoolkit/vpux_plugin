//
// Copyright (C) 2022-2023 Intel Corporation.
// SPDX-License-Identifier: Apache 2.0
//

// RUN: vpux-opt --split-input-file --init-compiler="vpu-arch=%arch% allow-custom-values=true" --tiling-strategy-assignment="tiling-mode=ISOLATED" %s | FileCheck %s
// REQUIRES: DISABLED
// TODO: #-81889 restore arch-NPU37XX and arch-NPU40XX

#NHWC = affine_map<(d0, d1, d2, d3) -> (d0, d2, d3, d1)>

!qElemType = !quant.uniform<u8:f16:3, {0.1:127, 0.2:127, 0.3:127, 0.4:127, 0.5:127, 0.6:127, 0.7:127, 0.8:127}>

// // 1x16x4x8xf16 + weights_table + profiling buffer
IE.TileResource 1 of @NCE at 1.300000e+03 MHz {
    IE.MemoryResource 4800 bytes of @CMX_NN
}

// CHECK-LABEL: func.func @MultiAxesAndPerAxisQuant
// CHECK-SAME:        [[INPUT:%arg[0-9]]]: tensor<1x32x8x8x!qElemType, {order = #NHWC}>
func.func @MultiAxesAndPerAxisQuant(
        %input: tensor<1x32x8x8x!qElemType, {order = #NHWC}>)
            -> tensor<1x32x8x8x!qElemType, {order = #NHWC}> {
    %weights_table = const.Declare tensor<32x1x1x4xsi32> = dense<1> : tensor<32x1x1x4xsi32>

    %0 = VPU.NCE.MaxPool(%input, %weights_table) {
        kernel_size = [3, 3],
        pad = #VPU.Padding<left = 1 : i64, right = 1 : i64, top = 1 : i64, bottom = 1 : i64>,
        strides = [1, 1]
    } -> tensor<1x32x8x8x!qElemType, {order = #NHWC}>

    return %0 : tensor<1x32x8x8x!qElemType, {order = #NHWC}>

    // CHECK-DAG:       [[WEIGHTS_TABLE:%.+]] = const.Declare tensor<32x1x1x4xsi32>
    // CHECK-SAME:      = dense<1> : tensor<32x1x1x4xsi32>

    // CHECK:       [[MAXPOOL:%.+]] = VPU.NCE.MaxPool(%arg0, [[WEIGHTS_TABLE]])
    // CHECK-SAME:          kernel_size = [3, 3],
    // CHECK-SAME:          pad = #VPU.Padding<left = 1 : i64, right = 1 : i64, top = 1 : i64, bottom = 1 : i64>,
    // CHECK-SAME:          strides = [1, 1],
    // CHECK-SAME:          tilingStrategy = [1, 1, 8, 1]}
    // CHECK-SAME:      -> tensor<1x32x8x8x!qElemType, {order = #NHWC}>

    // CHECK:       return [[MAXPOOL]] : tensor<1x32x8x8x!qElemType, {order = #NHWC}>
}

// -----

#NHWC = affine_map<(d0, d1, d2, d3) -> (d0, d2, d3, d1)>
#NCHW = affine_map<(d0, d1, d2, d3) -> (d0, d1, d2, d3)>

IE.TileResource 1 of @NCE at 1.300000e+03 MHz {
    IE.MemoryResource 1000000 bytes of @CMX_NN
}

// CHECK-LABEL: func.func @SplitNCEConvOverHAndAlignW
// CHECK-SAME:          [[INPUT:%arg[0-9]]]: tensor<1x3x224x224xf16>
func.func @SplitNCEConvOverHAndAlignW(%arg0: tensor<1x3x224x224xf16>) -> tensor<1x64x111x111xf16, {order = #NHWC}> {
    %weights = const.Declare tensor<64x1x1x32xf16, {order = #NHWC}> = dense<1.000000e+00> : tensor<64x3x3x3xf16>, [#const.Reorder<#NHWC>, #const.Reorder<#NCHW>, #const.Reshape<[64, 1, 1, 27]>, #const.PadWithZero<[0, 0, 0, 0], [0, 0, 0, 5]>, #const.Reorder<#NHWC>]
    %weights_table = const.Declare tensor<64x1x1x4xsi32> = dense<10> : tensor<64x1x1x4xsi32>

    %0 = VPU.NCE.Convolution(%arg0, %weights, %weights_table ) {
        pad = #VPU.Padding<left = 0 : i64, right = 0 : i64, top = 0 : i64, bottom = 0 : i64>,
        rawFilterShape = [64, 3, 3, 3],
        strides = [2, 2]
    } -> tensor<1x64x111x111xf16, {order = affine_map<(d0, d1, d2, d3) -> (d0, d2, d3, d1)>}>

    return %0 : tensor<1x64x111x111xf16, {order = #NHWC}>

    // CHECK-DAG:       [[WEIGHTS_TABLE:%.+]] = const.Declare tensor<64x1x1x4xsi32> = dense<10> : tensor<64x1x1x4xsi32>
    // CHECK-DAG:       [[WEIGHTS:%.+]] = const.Declare tensor<64x1x1x32xf16, {order = #NHWC}> = dense<1.000000e+00> : tensor<64x3x3x3xf16>, [#const.Reorder<#NHWC>, #const.Reorder<#NCHW>, #const.Reshape<[64, 1, 1, 27]>, #const.PadWithZero<[0, 0, 0, 0], [0, 0, 0, 5]>, #const.Reorder<#NHWC>]

    // CHECK:           [[CONV_0:%.+]] = VPU.NCE.Convolution(%arg0, [[WEIGHTS]], [[WEIGHTS_TABLE]])
    // CHECK-SAME:           pad = #VPU.Padding<left = 0 : i64, right = 0 : i64, top = 0 : i64, bottom = 0 : i64>,
    // CHECK-SAME:           rawFilterShape = [64, 3, 3, 3], strides = [2, 2], tilingStrategy = [1, 1, 2, 1]}
    // CHECK-SAME:              -> tensor<1x64x111x111xf16, {order = #NHWC}>

    // CHECK:           return [[CONV_0]] : tensor<1x64x111x111xf16, {order = #NHWC}>
}

// -----

#SparsityCompression = #VPU.SparsityCompression<
                            axis = 0 : i64,
                            numElems = dense<"0x7B0C0000000000002500000000000000000000000000000011000000000000009D0C0000000000000602000000000000C50C0000000000000000000000000000E50C0000000000007300000000000000000000000000000000000000000000008D0C00000000000000000000000000007E0C000000000000C20C0000000000006D0C000000000000C80C000000000000790C00000000000000000000000000000000000000000000800C0000000000000000000000000000C40C00000000000000000000000000007A0C000000000000E20C0000000000006A0C000000000000830C000000000000790C0000000000000000000000000000920C00000000000000000000000000000000000000000000980C000000000000EE0C0000000000007F0C000000000000000000000000000000000000000000004F0C00000000000000000000000000000000000000000000B10C000000000000830C000000000000000000000000000000000000000000000000000000000000890C000000000000ED0C0000000000006F0C0000000000008C0C000000000000000000000000000066040000000000007E0C0000000000008C0C0000000000000B00000000000000A40C0000000000000000000000000000950C00000000000000000000000000000000000000000000810C000000000000B30C00000000000000000000000000000000000000000000B90100000000000000000000000000000000000000000000C50C000000000000CD0C000000000000C80C000000000000000000000000000000000000000000007C0C000000000000880C000000000000C90C0000000000001800000000000000C30C0000000000000000000000000000870C000000000000070600000000000000000000000000008E0C00000000000000000000000000000000000000000000D20C000000000000A50C0000000000005F0C000000000000AF0D0000000000000000000000000000950C00000000000000000000000000006A0C000000000000A50C000000000000720C000000000000E90C0000000000000900000000000000250D0000000000006F0C00000000000000000000000000008C0C00000000000000000000000000000000000000000000990C0000000000000000000000000000780C0000000000000000000000000000690C0000000000000000000000000000A200000000000000660C000000000000380D00000000000000000000000000007B0C000000000000000000000000000000000000000000006E000000000000007A0C0000000000009E0C000000000000960C0000000000000000000000000000760C000000000000980C000000000000B40C000000000000780C000000000000710C00000000000000000000000000000400000000000000DE0C000000000000380D0000000000008C0C00000000000000000000000000007D0C000000000000270D0000000000000000000000000000780C0000000000007A0C000000000000DD0C000000000000CC0C0000000000000000000000000000720C000000000000000000000000000000000000000000008D0C000000000000250C0000000000000000000000000000AB0C000000000000750C0000000000007B0C000000000000A70C000000000000890C000000000000000000000000000000000000000000000000000000000000810C000000000000B30C0000000000007B0C000000000000910C00000000000000000000000000000000000000000000180D00000000000000000000000000000000000000000000CA0C00000000000000000000000000009E000000000000005A000000000000000000000000000000720C0000000000000000000000000000A90C000000000000000000000000000000000000000000007A0C0000000000000000000000000000790C000000000000A00C000000000000A10C0000000000007E0C0000000000000000000000000000000000000000000000000000000000000000000000000000EE0C000000000000650C000000000000D603000000000000000D000000000000850C000000000000AE0C0000000000007B0C000000000000E90C000000000000B80300000000000000000000000000006A07000000000000BE0C000000000000050D0000000000003B00000000000000090D000000000000000000000000000006080000000000001F00000000000000F607000000000000800C0000000000000000000000000000BE0C000000000000000000000000000000000000000000000000000000000000CB0C000000000000000000000000000000000000000000000000000000000000AC0C000000000000A40C000000000000850C0000000000000000000000000000720C000000000000BC0C0000000000007B0C0000000000000000000000000000A30D000000000000680C000000000000720C0000000000004100000000000000000000000000000000000000000000000000000000000000900C000000000000D20C0000000000007D0C000000000000E40C000000000000120D0000000000006A0C00000000000000000000000000008F0C000000000000940C000000000000F00C000000000000860C000000000000A70C0000000000007B0C00000000000037000000000000007A00000000000000700C000000000000860C0000000000006F0C000000000000830C0000000000000000000000000000D4030000000000000000000000000000DE0C00000000000000000000000000006C0C000000000000D40D00000000000000000000000000006E0C0000000000007B0C0000000000000000000000000000930C00000000000000000000000000000000000000000000740C000000000000C50C0000000000007A0C000000000000BD0C0000000000008C0C00000000000000000000000000000000000000000000000000000000000000000000000000008D0C000000000000000000000000000000000000000000009D0C00000000000000000000000000000000000000000000360D000000000000B30C0000000000006C0C0000000000000000000000000000CE0C0000000000000000000000000000790C0000000000000000000000000000880C0000000000005B0600000000000000000000000000000000000000000000BF0C000000000000A80C000000000000690C0000000000007A0C000000000000D00C0000000000000000000000000000730C000000000000AF0C000000000000750C0000000000000000000000000000740C00000000000000000000000000000000000000000000720C0000000000004F01000000000000E50C00000000000000000000000000007A0C0000000000000000000000000000C80600000000000000000000000000000000000000000000F50C000000000000030D000000000000000000000000000000000000000000008A0C000000000000000000000000000000000000000000007B0C00000000000000000000000000007B0C000000000000510C00000000000000000000000000000000000000000000A90C0000000000000000000000000000B40C000000000000480D0000000000000000000000000000C40C000000000000930C0000000000006D0C000000000000A30C000000000000690C000000000000770C00000000000000000000000000000000000000000000780C00000000000000000000000000007B0C0000000000000000000000000000A10C0000000000000000000000000000000000000000000064000000000000002B0D0000000000000000000000000000680C000000000000D30C00000000000000000000000000000000000000000000680C0000000000008F0C00000000000000000000000000000000000000000000B50C000000000000A10C000000000000700C000000000000750C000000000000A90C0000000000000000000000000000790C000000000000C70C000000000000860C00000000000000000000000000000000000000000000700C000000000000EA0C00000000000000000000000000000000000000000000720C0000000000000000000000000000AB0C000000000000DD0C000000000000D1000000000000002B000000000000007B0C000000000000BA060000000000000002000000000000F90C0000000000007B0C0000000000000000000000000000290D0000000000000900000000000000900C0000000000001D000000000000007B0C000000000000760C000000000000860C000000000000780C000000000000680C0000000000009E0C000000000000AC0C000000000000AB0C000000000000630A000000000000850C00000000000000000000000000000000000000000000120D0000000000001500000000000000000000000000000000000000000000007C0C000000000000890C000000000000DD0C000000000000870C00000000000000000000000000005104000000000000BE0C000000000000B30C000000000000790C0000000000008C0C000000000000800C00000000000000000000000000006D0D00000000000000000000000000000000000000000000AB0C0000000000007A0C000000000000D60C00000000000000000000000000008C0C0000000000000500000000000000D30C000000000000750C00000000000000000000000000007E0C0000000000000000000000000000770C000000000000850C00000000000000000000000000000000000000000000710C0000000000000000000000000000180200000000000000000000000000000000000000000000A90C0000000000004205000000000000720C0000000000000000000000000000830C000000000000A50C0000000000008D0C000000000000760C0000000000000000000000000000FD0C000000000000820C000000000000C202000000000000A20C0000000000000001000000000000000000000000000000000000000000000000000000000000850C000000000000840C0000000000000000000000000000DB0C0000000000000F00000000000000760C000000000000950C0000000000000000000000000000910C000000000000790C0000000000000000000000000000920C00000000000000000000000000006F0D0000000000003C09000000000000660D0000000000005C0C0000000000000000000000000000C50C0000000000007B0C000000000000810C000000000000690C0000000000007B0C000000000000980C0000000000000000000000000000B00C000000000000710C0000000000000000000000000000830C0000000000000000000000000000730C0000000000009F0C000000000000790C000000000000000000000000000000000000000000007D0C00000000000000000000000000006903000000000000830C00000000000000000000000000000000000000000000920C0000000000007B0C000000000000070D000000000000850C0000000000007A0C0000000000004700000000000000790C000000000000D70C000000000000800C000000000000A90C000000000000A70C00000000000000000000000000000200000000000000BE0C000000000000B30C0000000000000000000000000000CA0C000000000000700C000000000000C40C000000000000"> : tensor<512xi64>,
                            alignment = 16 : i64>

module @Test {
    IE.TileResource 1 of @NCE {
    IE.MemoryResource 1327104 bytes of @CMX_NN_FragmentationAware
    IE.MemoryResource 1474560 bytes of @CMX_NN {VPU.bandwidth = 64 : i64, VPU.derateFactor = 1.000000e+00 : f64}
    }

    func.func @TileNceConvOpWithSparseFilter(
            %input: tensor<1x512x46x60xf16, {order = affine_map<(d0, d1, d2, d3) -> (d0, d2, d3, d1)>}>,
            %bias: tensor<512x1x1x4xsi32>) {
        %sparsity_map = const.Declare tensor<512x1x1x4608xi1> = dense<1.0> : tensor<512x512x3x3xf16, {order = affine_map<(d0, d1, d2, d3) -> (d0, d2, d3, d1)>}>, [#const.GetSparsityMap]
        %data = const.Declare tensor<512x512x3x3xf16, {order = affine_map<(d0, d1, d2, d3) -> (d0, d2, d3, d1)>}> = dense<1.0> : tensor<512x512x3x3xf16, {order = affine_map<(d0, d1, d2, d3) -> (d0, d2, d3, d1)>}>, [#const.Sparsify<false>]
        %filter = VPU.GroupSparseTensor(%data, %sparsity_map) {
            is_weights,
            sparsity_compression = #SparsityCompression
            } -> !VPU.SparseTensor<
                        data=tensor<512x512x3x3xf16, {order = affine_map<(d0, d1, d2, d3) -> (d0, d2, d3, d1)>}>,
                        sparsity_map=tensor<512x1x1x4608xi1>,
                        is_weights,
                        #SparsityCompression>
        %0 = VPU.NCE.Convolution(%input, %filter, %bias) {
            mpe_engine = #VPU.MPEEngine37XX<mode = <SCL>>,
            pad = #VPU.Padding<left = 1 : i64, right = 1 : i64, top = 1 : i64, bottom = 1 : i64>,
            ppe = #VPU.PPEFp<mode = <LRELU>,
            clamp_low = 0.000000e+00 : f64,
            clamp_high = 3.4028234663852886E+38 : f64,
            scale = [1.000000e+00],
            prelu_alpha = [1.000000e+00],
            bias = [0.000000e+00],
            adder = [0.000000e+00]>,
            rawFilterShape = [512, 512, 3, 3],
            strides = [1, 1]
            } -> tensor<1x512x46x60xf16, {order = affine_map<(d0, d1, d2, d3) -> (d0, d2, d3, d1)>}>
        return

        // CHECK: tilingStrategy = [1, 2, 45, 1]
    }
}
